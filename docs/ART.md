# Debugging the Android Runtime (ART)
## Debugging OAT files with LLDB
* Generate symbols for OAT files: `oatdump --symbolize=path/to/boot.oat --output=/storage/boot.oat`
* Generate symbols and extended debug info: `adb shell setprop debug.generate-debug-info true`
  This will generate more sections (`.gnu_debugdata`, `.debug_frame`) than manually running oatdump symbolize.
* Manually trigger dex2oat compiler for an existing package: `adb shell cmd package compile -f -m everything org.packagename`
* Get optimization status of package: `dumpsys package org.packagename`
  If no OAT file is present, the status will be set to `run-from-apk`.
* Load symbols in LLDB: `(lldb) target symbols add /storage/boot.oat`
* For Android Studio projects, set the active build variant (Build > Select Build Variant) to release.
  Debug versions donâ€™t seem to be compiled AOT.
    * Alternatively, appending the following gradle task to `build.gradle` and running it will install a debug build and generate OAT files:
    ```gradle
    task launchDebugOAT(dependsOn: 'installDebug') {
        doLast {
            exec {
                commandLine android.adbExe, "shell", "cmd package compile -f -m everything ${android.defaultConfig.applicationId}"
            }
            exec {
                commandLine android.adbExe, "shell", "am start -n ${android.defaultConfig.applicationId}/.MainActivity"
            }
        }
    }
    ```

## Profile-guided compilation
* Since Android N, not everything is compiled AOT to reduce binary sizes and delay after updating system libraries.
* We can force the system to AOT everything with: `adb shell setprop pm.dexopt.install everything`. This will invoke dex2oat with the flag `compiler-filter=everything` (default was speed-profile)
* To compile the entire app after updating the app via OTA: `adb shell setprop pm.dexopt.boot everything` (default: verify)

## Other ART options
* To disable JIT: `adb shell setprop dalvik.vm.usejit false`
* To use debug version of ART: `adb shell setprop persist.sys.dalvik.vm.lib.2 libartd.so`
  This requires the image to be built with `PRODUCT_ART_TARGET_INCLUDE_DEBUG_BUILD`

# Paths
* OAT of system apps seem to be installed to `/data/dalvik-cache/arm/*.dex`
  (has dex extension but really is an OAT file). This might be because
  `/system/` is mounted as read-only.
* For user-installed apps, apk and oat files reside under `/data/app/<package-name>-<randomid>/`
  where `randomid` is generated on the device per reinstall or update.
  * An `oat` directory is only present if the apk has been optimized with the AOT compiler.
    It can be generated by manually invoking the dex2oat compiler, or setting
    the default compiler-filter for installed apps with `setprop`.
## File types
The file extension should not be used as the only source of truth for determining the file type.
* `.dex` files may contain the original Dalvik bytecode (e.g. `classes.dex` in an APK file).
* `.dex` and `.odex` files might be an OAT file (ELF file with native instructions compiled from bytecode).
* `.vdex` files contain the original Dalvik bytecode. If the app isn't fully optimized with dex2oat,
  the whole `classes.dex` file of the apk is present.
  Instructions in OAT files refer to `.vdex` files for data e.g. strings, even when all bytecode has
  been compiled to OAT.

## Useful references
* [Default options of many different android installations](https://census.tsyrklevich.net/)
* [Info about profiling and debug symbols](https://android.googlesource.com/platform/prebuilts/simpleperf/+/25ade08061f50806eeba92700ac43a07064e1c32/README.md)
